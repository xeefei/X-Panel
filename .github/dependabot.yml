name: Dependency Update Check

于:
  workflow_dispatch:
  schedule:
    # 每天早上8点检查依赖更新
    - cron: '0 0 * * *'
  pull_request:
    types: [opened， synchronize, reopened]
    paths:
      - 'go.mod'
      - 'go.sum'

jobs:
  update-deps:
    name: Update Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version-file: go.mod
        check-latest: true

    - name: Run go mod tidy
      run: go mod tidy

    - name: Check for updates
      id: check-updates
      run: |
        # 检查是否有未提交的更改
        if git diff --quiet go.mod go.sum; then
          echo "no-updates=true" >> $GITHUB_OUTPUT
          echo "No dependency updates needed"
        else
          echo "no-updates=false" >> $GITHUB_OUTPUT
          echo "Dependencies need updating"
        fi

    - name: Run tests with updated dependencies
      if: steps.check-updates.outputs.no-updates == 'false'
      run: |
        go test ./... -v

    - name: Create Pull Request
      if: steps.check-updates.outputs.no-updates == 'false'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: update Go dependencies

          - Updated Go module dependencies
          - Ran go mod tidy
          - Verified tests pass
        title: "chore: update Go dependencies"
        body: |
          This PR updates Go dependencies using `go mod tidy`.

          ## Changes
          - Updated dependencies in go.mod and go.sum
          - Verified all tests pass

          ## Testing
          - All existing tests continue to pass
        branch: deps/go-updates
        delete-branch: true
        labels: |
          dependencies
          automated

  vulnerability-check:
    name: Security Vulnerability Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Go
      uses: actions/setup-go@v6
      with:
        go-version-file: go.mod
        check-latest: true

    - name: Run Govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck -format sarif ./... > govulncheck-report.sarif

    - name: Upload SARIF file
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: govulncheck-report.sarif
        category: govulncheck
